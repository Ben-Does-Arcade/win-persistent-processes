# Creates two independent processes that check each other and respawn whenever it is killed, runs infinitel

$processCount = 1
$evilProcess1 = "notepad"
$evilProcess2 = "charmap"

function duelingProcesses() {
    SpawnProcesses
    MonitorProcesses
}

function GetLength() {
    # Count processes by their name (no need for 'Path')
    $processLength1 = (Get-Process -Name $evilProcess1 -ErrorAction SilentlyContinue).Count
    $processLength2 = (Get-Process -Name $evilProcess2 -ErrorAction SilentlyContinue).Count
    
    # Handle null results for missing processes
    $processLength1 = if ($processLength1 -eq $null) { 0 } else { $processLength1 }
    $processLength2 = if ($processLength2 -eq $null) { 0 } else { $processLength2 }
    
    Write-Host -ForegroundColor Yellow "Currently running $evilProcess1 : $processLength1 and $evilProcess2 : $processLength2"
    return $processLength1 + $processLength2
}

function SpawnProcesses() {
    Write-Host -ForegroundColor Blue "Running Notepad and Charmap..."
    Start-Process -FilePath "notepad.exe"
    Start-Process -FilePath "charmap.exe"
    Start-Sleep -Seconds 3
}

function MonitorProcesses() {
    while ($true) {
        $currentProcessCount = GetLength
        
        # Check if process count is not as expected
        if ($currentProcessCount -lt $processCount) {
            Write-Host -ForegroundColor Red "Mismatch detected. Spawning both processes again..."
            SpawnProcesses
            $processCount += 1
            Start-Sleep -Seconds 1 # Delay to reduce CPU usage
        } else {
            Write-Host -ForegroundColor Green "Process count is okay. $currentProcessCount processes running."
            Start-Sleep -Seconds 1 # Delay to reduce CPU usage
        }

        # Kill Task Manager if running
        if (Get-Process -Name "taskmgr" -ErrorAction SilentlyContinue) {
            Write-Host -ForegroundColor Yellow "Task Manager is running. Killing it..."
            Stop-Process -Name "taskmgr" -Force
        }
    }
}

Clear-Host
duelingProcesses
